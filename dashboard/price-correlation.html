<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tweet-Price Correlation ‚Äî Do Founder Tweets Move Token Prices? | XActions</title>
  <meta name="description" content="Interactive chart showing how crypto founder tweets correlate with token price movements. TradingView-style candlesticks with tweet markers, silence gaps, and impact analysis.">
  <meta name="keywords" content="tweet price correlation, crypto founder tweets, token price impact, twitter crypto analysis, tweet price charts, founder tweet analysis">
  <meta name="author" content="nich (@nichxbt)">
  <meta name="robots" content="index, follow">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Tweet-Price Correlation ‚Äî XActions">
  <meta property="og:description" content="Do founder tweets move token prices? Interactive chart with candlesticks, tweet markers, and price impact analysis.">
  <meta property="og:url" content="https://xactions.app/price-correlation">
  <meta property="og:site_name" content="XActions">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@nichxbt">
  <meta name="twitter:title" content="Tweet-Price Correlation ‚Äî XActions">

  <link rel="canonical" href="https://xactions.app/price-correlation">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebApplication","name":"XActions Tweet-Price Correlation","description":"Interactive chart showing crypto founder tweet correlation with token price movements","url":"https://xactions.app/price-correlation","applicationCategory":"AnalyticsApplication","operatingSystem":"Web Browser","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}
  </script>

  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #131722;
      --bg-tertiary: #1e222d;
      --bg-card: #1a1e2e;
      --bg-hover: #252a3a;
      --accent: #1d9bf0;
      --accent-hover: #1a8cd8;
      --text-primary: #d1d4dc;
      --text-secondary: #787b86;
      --text-muted: #555;
      --border: #2a2e39;
      --green: #26a69a;
      --green-bright: #22e29a;
      --red: #ef5350;
      --red-dim: #cc3c3a;
      --purple: #a855f7;
      --yellow: #ffeb3b;
      --orange: #ff9800;
      --cyan: #00bcd4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ===== Top Bar ===== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .token-logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .token-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .token-badge {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .token-pair {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .view-tab {
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      transition: all 0.15s;
    }
    .view-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
    .view-tab.active { color: #fff; background: var(--accent); }

    /* ===== Chart Sub-header ===== */
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .chart-header-left {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chart-tab {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid transparent;
      transition: all 0.15s;
    }
    .chart-tab:hover { color: var(--text-primary); }
    .chart-tab.active { color: var(--text-primary); border-color: var(--border); background: var(--bg-tertiary); }

    .chart-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ===== Chart Container ===== */
    .chart-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 140px);
      min-height: 500px;
      background: var(--bg-secondary);
    }

    #chart { width: 100%; height: 100%; }

    /* Tweet marker overlay */
    .tweet-markers-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .tweet-marker {
      position: absolute;
      pointer-events: auto;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .tweet-marker:hover { transform: scale(1.2); z-index: 20; }

    .marker-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--purple);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      position: relative;
      overflow: hidden;
    }
    .marker-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .marker-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--yellow);
      color: #000;
      font-size: 9px;
      font-weight: 700;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    /* Tooltip */
    .tweet-tooltip {
      display: none;
      position: absolute;
      bottom: 42px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      width: 280px;
      z-index: 30;
      pointer-events: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .tweet-marker:hover .tweet-tooltip { display: block; }
    .tweet-tooltip .tt-date { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
    .tweet-tooltip .tt-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; margin-bottom: 6px; }
    .tweet-tooltip .tt-impact { display: flex; gap: 12px; font-size: 12px; font-weight: 600; }
    .tweet-tooltip .tt-impact .positive { color: var(--green-bright); }
    .tweet-tooltip .tt-impact .negative { color: var(--red); }

    /* ===== Footer Bar ===== */
    .footer-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .footer-left label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .footer-left input[type="checkbox"] {
      accent-color: var(--accent);
    }

    .footer-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .legend-dot.single { border: 2px solid var(--text-secondary); background: transparent; }
    .legend-dot.cluster { background: var(--purple); }
    .legend-line {
      width: 20px;
      height: 0;
      border-top: 2px dashed var(--red);
    }

    /* ===== Timeframe Buttons ===== */
    .timeframe-bar {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      gap: 2px;
      z-index: 15;
      background: rgba(19, 23, 34, 0.85);
      border-radius: 6px;
      padding: 2px;
    }

    .tf-btn {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      transition: all 0.15s;
    }
    .tf-btn:hover { color: var(--text-primary); }
    .tf-btn.active { color: #fff; background: var(--accent); }

    /* ===== Data Table View ===== */
    .data-table-view {
      display: none;
      padding: 0;
      overflow-x: auto;
    }
    .data-table-view.active { display: block; }

    .data-table-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .search-input {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 14px;
      color: var(--text-primary);
      font-size: 13px;
      width: 260px;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-muted); }

    .export-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .export-btn:hover { background: var(--bg-hover); border-color: var(--accent); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      padding: 10px 12px;
      text-align: left;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 0;
      border-bottom: 1px solid var(--border);
    }
    thead th:hover { color: var(--text-primary); }
    thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
    thead th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
      cursor: pointer;
    }
    tbody tr:hover { background: var(--bg-hover); }

    td {
      padding: 10px 12px;
      white-space: nowrap;
    }
    td.tweet-text-cell {
      white-space: normal;
      max-width: 320px;
      line-height: 1.4;
    }

    .change-positive { color: var(--green-bright); font-weight: 600; }
    .change-negative { color: var(--red); font-weight: 600; }
    .change-neutral { color: var(--text-secondary); }

    /* ===== About View ===== */
    .about-view {
      display: none;
      padding: 32px;
      max-width: 900px;
      margin: 0 auto;
    }
    .about-view.active { display: block; }

    .about-hero {
      text-align: center;
      margin-bottom: 48px;
    }

    .about-hero h1 {
      font-size: 32px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .about-hero p {
      font-size: 16px;
      color: var(--text-secondary);
      max-width: 500px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .about-section {
      margin-bottom: 32px;
    }

    .about-section h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .about-section p, .about-section li {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .about-section ul {
      list-style: none;
      padding: 0;
    }

    .about-section li::before {
      content: '‚Üí ';
      color: var(--accent);
    }

    .silence-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .silence-dates { font-size: 13px; color: var(--text-secondary); }
    .silence-gap { font-size: 14px; font-weight: 600; }
    .silence-change { font-size: 14px; font-weight: 700; }

    /* Impact scatter mini-chart */
    .impact-scatter {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }

    .impact-scatter h3 {
      font-size: 16px;
      margin-bottom: 16px;
    }

    #impactCanvas {
      width: 100%;
      height: 280px;
    }

    /* ===== Setup Panel (shown when no data) ===== */
    .setup-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 100px);
      padding: 40px;
      text-align: center;
    }

    .setup-panel h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .setup-panel p {
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 500px;
    }

    .setup-form {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 480px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus { border-color: var(--accent); }

    .form-group .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .submit-btn:hover { background: var(--accent-hover); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .or-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
      color: var(--text-muted);
      font-size: 12px;
    }
    .or-divider::before, .or-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .demo-btn {
      width: 100%;
      padding: 12px;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .demo-btn:hover { background: rgba(29, 155, 240, 0.1); }

    /* Loading */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 15, 0.9);
      z-index: 200;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .loading-overlay.active { display: flex; }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text { font-size: 14px; color: var(--text-secondary); }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .topbar { flex-wrap: wrap; gap: 8px; }
      .chart-container { height: calc(100vh - 180px); min-height: 400px; }
      .setup-form { padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
      .about-view { padding: 20px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .tweet-tooltip { width: 220px; }
    }

    .credit-link {
      color: var(--text-muted);
      text-decoration: none;
      transition: color 0.2s;
    }
    .credit-link:hover { color: var(--accent); }
  </style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <div class="topbar-left">
    <div class="token-logo" id="tokenLogo">‚ö°</div>
    <span class="token-name" id="tokenName">‚Äî</span>
    <span class="token-badge" id="tokenNetwork">‚Äî</span>
    <span class="token-pair">/USD</span>
  </div>
  <div class="topbar-right">
    <button class="view-tab active" data-view="chart">Chart</button>
    <button class="view-tab" data-view="data">Data Table</button>
    <button class="view-tab" data-view="about">About</button>
  </div>
</div>

<!-- ===== CHART VIEW ===== -->
<div id="chartView">
  <div class="chart-header">
    <div class="chart-header-left">
      <button class="chart-tab active" data-range="tweets">üê¶ Tweets</button>
      <button class="chart-tab" data-range="first">First Tweet</button>
      <button class="chart-tab" data-range="all">All Time</button>
      <button class="chart-tab" data-range="last">Last Tweet</button>
    </div>
    <div class="chart-header-right">
      <span id="priceDisplay">‚Äî</span>
    </div>
  </div>

  <div class="chart-container">
    <div id="chart"></div>
    <div class="tweet-markers-layer" id="markersLayer"></div>
    <div class="timeframe-bar">
      <button class="tf-btn" data-tf="1">1m</button>
      <button class="tf-btn" data-tf="15">15m</button>
      <button class="tf-btn" data-tf="60">1h</button>
      <button class="tf-btn active" data-tf="D">1D</button>
    </div>
  </div>

  <div class="footer-bar">
    <div class="footer-left">
      <span id="founderHandle">@‚Äî</span>
      <label><input type="checkbox" id="onlyMentions"> Only mentions</label>
    </div>
    <div class="footer-right">
      <span class="legend-item"><span class="legend-dot single"></span> 1 tweet</span>
      <span class="legend-item"><span class="legend-dot cluster"></span> 3+ tweets</span>
      <span class="legend-item"><span class="legend-line"></span> Quiet period</span>
      <span id="tweetCountInfo">‚Äî</span>
    </div>
  </div>
</div>

<!-- ===== DATA TABLE VIEW ===== -->
<div class="data-table-view" id="dataView">
  <div class="data-table-controls">
    <input type="text" class="search-input" id="tableSearch" placeholder="Search tweets...">
    <button class="export-btn" id="exportCSV">üì• Export CSV</button>
  </div>
  <table>
    <thead>
      <tr>
        <th data-sort="datetime">Date <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="text">Tweet <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="priceAtTweet">Price <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="likes">Likes <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="reposts">Reposts <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="change1h">1h Impact <span class="sort-arrow">‚Üï</span></th>
        <th data-sort="change24h">24h Impact <span class="sort-arrow">‚Üï</span></th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- ===== ABOUT VIEW ===== -->
<div class="about-view" id="aboutView">
  <div class="about-hero">
    <h1>Tweet-Price Correlation</h1>
    <p>Most founder tweets do nothing. Some coincide with big moves. This tool helps you see which.</p>
  </div>

  <div class="stats-grid" id="statsGrid"></div>

  <div class="impact-scatter about-section">
    <h3>Impact Explorer ‚Äî Tweets vs 24h Price Change</h3>
    <canvas id="impactCanvas"></canvas>
  </div>

  <div class="about-section" id="silencesSection">
    <h3>Notable Silences</h3>
    <p style="margin-bottom: 12px; color: var(--text-secondary);">Quiet periods of 48h+ when the founder didn't tweet, and what happened to the price.</p>
    <div id="silencesList"></div>
  </div>

  <div class="about-section">
    <h3>How It Works</h3>
    <ul>
      <li>Scrape tweet timestamps from a founder's X/Twitter profile</li>
      <li>Fetch hourly price data from CoinGecko or GeckoTerminal</li>
      <li>Align each tweet to the nearest price candle</li>
      <li>Measure 1h and 24h price change after each tweet</li>
      <li>Detect silence gaps and their price context</li>
    </ul>
  </div>

  <div class="about-section" style="text-align: center; margin-top: 40px;">
    <p style="font-size: 12px;">
      Inspired by <a href="https://github.com/rohunvora/tweet-price-charts" class="credit-link" target="_blank">tweet-price-charts</a> by rohunvora
      ¬∑ Built with <a href="https://github.com/nirholas/XActions" class="credit-link" target="_blank">XActions</a> by nichxbt
    </p>
  </div>
</div>

<!-- ===== SETUP PANEL (no data yet) ===== -->
<div class="setup-panel" id="setupPanel">
  <h2>üìä Tweet-Price Correlation</h2>
  <p>Enter a token and founder's Twitter handle to analyze how their tweets correlate with price movements.</p>

  <div class="setup-form">
    <div class="form-group">
      <label>Founder's X Handle</label>
      <input type="text" id="inputHandle" placeholder="@a1lon9" value="">
      <div class="hint">The founder or key person whose tweets you want to track</div>
    </div>

    <div class="form-group">
      <label>Token (CoinGecko ID)</label>
      <input type="text" id="inputTokenId" placeholder="solana, bitcoin, jupiter-exchange-solana...">
      <div class="hint">Find it at coingecko.com/en/coins/TOKEN ‚Äî use the URL slug</div>
    </div>

    <div class="or-divider">OR use GeckoTerminal (for DEX-only tokens)</div>

    <div class="form-row">
      <div class="form-group">
        <label>Network</label>
        <select id="inputNetwork">
          <option value="">‚Äî</option>
          <option value="solana">Solana</option>
          <option value="eth">Ethereum</option>
          <option value="bsc">BSC</option>
          <option value="base">Base</option>
          <option value="arbitrum">Arbitrum</option>
        </select>
      </div>
      <div class="form-group">
        <label>Pool Address</label>
        <input type="text" id="inputPoolAddress" placeholder="0x...">
      </div>
    </div>

    <div class="form-group">
      <label>Token Display Name</label>
      <input type="text" id="inputTokenName" placeholder="$PUMP">
    </div>

    <button class="submit-btn" id="analyzeBtn">üîç Analyze Correlation</button>

    <div class="or-divider">or try a demo</div>

    <button class="demo-btn" id="demoBtn">üìà Load Demo Data ($PUMP √ó @a1lon9)</button>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Fetching data...</div>
</div>

<script>
// ============================================================================
// XActions Tweet-Price Correlation Dashboard
// Inspired by https://github.com/rohunvora/tweet-price-charts
// by nichxbt
// ============================================================================

(() => {
  'use strict';

  // ===== State =====
  let state = {
    data: null,        // { aligned, stats, meta }
    view: 'chart',     // chart | data | about
    timeframe: 'D',
    chartRange: 'tweets',
    sortCol: 'change24h',
    sortDir: -1,
    searchQuery: '',
    chart: null,
    candleSeries: null,
    markers: [],
  };

  // ===== DOM Refs =====
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  // ===== View Switching =====
  $$('.view-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.view-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      state.view = tab.dataset.view;
      updateView();
    });
  });

  function updateView() {
    $('#chartView').style.display = state.view === 'chart' ? '' : 'none';
    $('#dataView').classList.toggle('active', state.view === 'data');
    $('#aboutView').classList.toggle('active', state.view === 'about');
    if (state.view === 'data' && state.data) renderTable();
    if (state.view === 'about' && state.data) renderAbout();
  }

  // ===== Chart Range Tabs =====
  $$('.chart-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      $$('.chart-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      state.chartRange = tab.dataset.range;
      if (state.data) fitChartRange();
    });
  });

  // ===== Timeframe Buttons =====
  $$('.tf-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.tf-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.timeframe = btn.dataset.tf;
      // For now we only have daily data, but the buttons are wired up
    });
  });

  // ===== Setup / Analyze =====
  $('#analyzeBtn').addEventListener('click', startAnalysis);
  $('#demoBtn').addEventListener('click', loadDemo);

  async function startAnalysis() {
    const handle = $('#inputHandle').value.trim().replace(/^@/, '');
    const tokenId = $('#inputTokenId').value.trim();
    const network = $('#inputNetwork').value;
    const poolAddress = $('#inputPoolAddress').value.trim();
    const tokenName = $('#inputTokenName').value.trim() || tokenId.toUpperCase() || 'TOKEN';

    if (!handle) return alert('Enter a Twitter handle');
    if (!tokenId && !(network && poolAddress)) return alert('Enter a CoinGecko token ID or GeckoTerminal network + pool');

    showLoading('Scraping tweets for @' + handle + '...');

    try {
      // Step 1: Try to call our API if available
      const apiBase = window.location.origin;
      const tweets = await scrapeTweetsViaPage(handle);

      if (!tweets.length) {
        hideLoading();
        alert('Could not find tweets. Make sure the handle is correct.');
        return;
      }

      updateLoading(`Found ${tweets.length} tweets. Fetching prices...`);

      // Step 2: Call our price-correlation API
      const body = { tweets, windows: [1, 24] };
      if (tokenId) body.tokenId = tokenId;
      else { body.network = network; body.poolAddress = poolAddress; }

      let result;
      try {
        const resp = await fetch(apiBase + '/api/analytics/price-correlation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (resp.ok) {
          result = await resp.json();
        } else {
          throw new Error('API not available');
        }
      } catch {
        // Fallback: fetch prices directly from browser
        updateLoading('API unavailable. Fetching prices directly...');
        result = await analyzeLocally(tweets, { tokenId, network, poolAddress });
      }

      state.data = {
        ...result,
        meta: {
          ...result.meta,
          handle,
          tokenName,
          tokenNetwork: network || 'CoinGecko',
        },
      };

      hideLoading();
      $('#setupPanel').style.display = 'none';
      renderAll();

    } catch (err) {
      hideLoading();
      console.error(err);
      alert('Error: ' + err.message);
    }
  }

  // ===== Tweet scraping via nitter or direct (lightweight) =====
  async function scrapeTweetsViaPage(handle) {
    // Try multiple Nitter instances for tweet data
    const nitterInstances = [
      `https://nitter.privacydev.net/${handle}`,
      `https://nitter.poast.org/${handle}`,
    ];

    for (const url of nitterInstances) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) continue;
        const html = await resp.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const tweetEls = doc.querySelectorAll('.timeline-item');
        if (!tweetEls.length) continue;

        const tweets = [];
        tweetEls.forEach(el => {
          const dateEl = el.querySelector('.tweet-date a');
          const textEl = el.querySelector('.tweet-content');
          const statsEls = el.querySelectorAll('.tweet-stat .icon-container');

          const dateStr = dateEl?.getAttribute('title');
          if (!dateStr) return;

          const timestamp = new Date(dateStr).getTime();
          if (isNaN(timestamp)) return;

          tweets.push({
            timestamp,
            text: (textEl?.textContent || '').trim().substring(0, 280),
            url: `https://x.com/${handle}/status/${(dateEl?.href || '').split('/').pop()}`,
            likes: parseInt(statsEls[3]?.textContent?.trim()?.replace(/,/g, '')) || 0,
            reposts: parseInt(statsEls[1]?.textContent?.trim()?.replace(/,/g, '')) || 0,
            replies: parseInt(statsEls[0]?.textContent?.trim()?.replace(/,/g, '')) || 0,
          });
        });

        if (tweets.length) return tweets;
      } catch { continue; }
    }

    // If Nitter fails, return empty (user should use DevTools script instead)
    return [];
  }

  // ===== Direct browser-side analysis (no API needed) =====
  async function analyzeLocally(tweets, { tokenId, network, poolAddress }) {
    const sorted = [...tweets].sort((a, b) => a.timestamp - b.timestamp);
    const firstTs = Math.floor(sorted[0].timestamp / 1000) - 86400;
    const lastTs = Math.floor(sorted[sorted.length - 1].timestamp / 1000) + 86400 * 2;

    let prices;
    if (tokenId) {
      const url = `https://api.coingecko.com/api/v3/coins/${tokenId}/market_chart/range?vs_currency=usd&from=${firstTs}&to=${lastTs}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('CoinGecko API error: ' + resp.status);
      const data = await resp.json();
      prices = (data.prices || []).map(([ts, price]) => ({ ts, price }));
    } else {
      const url = `https://api.geckoterminal.com/api/v2/networks/${network}/pools/${poolAddress}/ohlcv/hour?aggregate=1&limit=1000`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('GeckoTerminal API error: ' + resp.status);
      const data = await resp.json();
      prices = (data?.data?.attributes?.ohlcv_list || [])
        .map(([ts, o, h, l, c]) => ({ ts: ts * 1000, price: parseFloat(c), open: parseFloat(o), high: parseFloat(h), low: parseFloat(l), close: parseFloat(c) }))
        .filter(p => p.ts >= firstTs * 1000 && p.ts <= lastTs * 1000)
        .sort((a, b) => a.ts - b.ts);
    }

    if (!prices.length) throw new Error('No price data returned');

    // Align
    const windows = [1, 24];
    const aligned = sorted.map(tweet => {
      const atTweet = closest(prices, tweet.timestamp);
      if (!atTweet) return { ...tweet, priceAtTweet: null, impact: {} };
      const impact = {};
      for (const h of windows) {
        const futureTs = tweet.timestamp + h * 3600_000;
        const fp = closest(prices, futureTs);
        if (fp && Math.abs(fp.ts - futureTs) < h * 3600_000 * 0.5) {
          impact[`${h}h`] = { price: fp.price, change: Math.round(((fp.price - atTweet.price) / atTweet.price) * 10000) / 100 };
        }
      }
      return { ...tweet, priceAtTweet: atTweet.price, impact };
    });

    // Stats
    const withImpact = aligned.filter(r => r.impact?.['24h']);
    const c24 = withImpact.map(r => r.impact['24h'].change);
    const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    const med = arr => { const s = [...arr].sort((a, b) => a - b); const m = Math.floor(s.length / 2); return s.length % 2 ? s[m] : (s[m-1]+s[m])/2; };

    const stats = c24.length ? {
      totalTweets: aligned.length,
      tweetsWithPriceData: withImpact.length,
      avgChange24h: Math.round(avg(c24) * 100) / 100,
      medianChange24h: Math.round(med(c24) * 100) / 100,
      winRate: Math.round((c24.filter(c => c > 0).length / c24.length) * 10000) / 100,
      bigMoves: c24.filter(c => Math.abs(c) >= 15).length,
      bigMovePct: Math.round((c24.filter(c => Math.abs(c) >= 15).length / c24.length) * 10000) / 100,
      avgHoursBetweenTweets: (() => { const ts = aligned.map(r => r.timestamp).sort(); const g = []; for(let i=1;i<ts.length;i++) g.push((ts[i]-ts[i-1])/3600000); return g.length ? Math.round(avg(g)*10)/10 : null; })(),
      silences: (() => { const ts = aligned.map(r => r.timestamp).sort((a,b)=>a-b); const s = []; for(let i=1;i<ts.length;i++){ const gh=(ts[i]-ts[i-1])/3600000; if(gh>=48) s.push({startDate:new Date(ts[i-1]).toISOString(),endDate:new Date(ts[i]).toISOString(),gapHours:Math.round(gh)}); } return s; })(),
      bestTweet: withImpact.reduce((b,r) => r.impact['24h'].change > (b?.impact?.['24h']?.change??-Infinity)?r:b, null),
      worstTweet: withImpact.reduce((w,r) => r.impact['24h'].change < (w?.impact?.['24h']?.change??Infinity)?r:w, null),
    } : null;

    return {
      aligned, stats,
      meta: { token: tokenId || `${network}/${poolAddress}`, priceSource: tokenId ? 'coingecko' : 'geckoterminal', pricePoints: prices.length },
      _prices: prices,
    };
  }

  function closest(prices, targetTs) {
    let best = null, bestDiff = Infinity;
    for (const p of prices) {
      const d = Math.abs(p.ts - targetTs);
      if (d < bestDiff) { bestDiff = d; best = p; }
      if (best && d > bestDiff) break;
    }
    return best;
  }

  // ===== Demo Data =====
  async function loadDemo() {
    showLoading('Loading demo data ($PUMP √ó @a1lon9)...');
    try {
      // Generate realistic demo data
      const demoTweets = generateDemoData();
      const demoPrices = generateDemoPrices();

      const windows = [1, 24];
      const aligned = demoTweets.map(tweet => {
        const atTweet = closest(demoPrices, tweet.timestamp);
        if (!atTweet) return { ...tweet, priceAtTweet: null, impact: {} };
        const impact = {};
        for (const h of windows) {
          const futureTs = tweet.timestamp + h * 3600_000;
          const fp = closest(demoPrices, futureTs);
          if (fp && Math.abs(fp.ts - futureTs) < h * 3600_000 * 0.5) {
            impact[`${h}h`] = { price: fp.price, change: Math.round(((fp.price - atTweet.price) / atTweet.price) * 10000) / 100 };
          }
        }
        return { ...tweet, priceAtTweet: atTweet.price, impact };
      });

      const withImpact = aligned.filter(r => r.impact?.['24h']);
      const c24 = withImpact.map(r => r.impact['24h'].change);
      const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
      const med = arr => { const s = [...arr].sort((a,b)=>a-b); const m = Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; };

      const stats = {
        totalTweets: aligned.length,
        tweetsWithPriceData: withImpact.length,
        avgChange24h: Math.round(avg(c24)*100)/100,
        medianChange24h: Math.round(med(c24)*100)/100,
        winRate: Math.round((c24.filter(c=>c>0).length/c24.length)*10000)/100,
        bigMoves: c24.filter(c=>Math.abs(c)>=15).length,
        bigMovePct: Math.round((c24.filter(c=>Math.abs(c)>=15).length/c24.length)*10000)/100,
        avgHoursBetweenTweets: 18.4,
        silences: [
          { startDate: '2025-10-15T00:00:00Z', endDate: '2025-10-24T00:00:00Z', gapHours: 216, priceChange: -9.8 },
          { startDate: '2025-11-20T00:00:00Z', endDate: '2026-01-24T00:00:00Z', gapHours: 1560, priceChange: -29 },
        ],
        bestTweet: withImpact.reduce((b,r)=>r.impact['24h'].change>(b?.impact?.['24h']?.change??-Infinity)?r:b,null),
        worstTweet: withImpact.reduce((w,r)=>r.impact['24h'].change<(w?.impact?.['24h']?.change??Infinity)?r:w,null),
      };

      state.data = {
        aligned,
        stats,
        meta: { handle: 'a1lon9', tokenName: '$PUMP', tokenNetwork: 'SOLANA', token: 'pump', priceSource: 'geckoterminal', pricePoints: demoPrices.length },
        _prices: demoPrices,
      };

      hideLoading();
      $('#setupPanel').style.display = 'none';
      renderAll();
    } catch (err) {
      hideLoading();
      console.error(err);
      alert('Demo error: ' + err.message);
    }
  }

  function generateDemoData() {
    // Simulate ~109 tweets from Aug 2025 to Feb 2026 for $PUMP by @a1lon9
    const tweets = [];
    const start = new Date('2025-08-01').getTime();
    const end = new Date('2026-02-15').getTime();
    const texts = [
      'Pump is alive and well üöÄ', 'Big things coming for the community',
      'Just shipped a major update', 'LFG üî•', 'Market looking interesting rn',
      'Building through the noise', 'New partnership incoming üëÄ',
      'GM to all pump holders', 'Reminds me of early days', 'This is just the beginning',
      'We dont stop building', 'Number go up technology', 'Stay focused, stay building',
      'The real ones know ü´°', 'Another milestone reached', 'Community is everything',
      'This bear market is a gift', 'Innovation never sleeps', 'Chart looking healthy',
      'We are so back', 'Wagmi frens', 'Just wait and see what happens next',
    ];

    // Create clusters of tweets (some days have many, some have gaps)
    const clusterDays = [0, 3, 5, 18, 20, 22, 35, 37, 50, 52, 53, 55, 72, 73, 80, 85, 90, 100, 105, 110, 120, 125, 135, 140, 150, 160, 165, 170, 180, 190, 195, 198];
    for (const dayOffset of clusterDays) {
      const dayTs = start + dayOffset * 86400_000;
      if (dayTs > end) break;
      const tweetsThisDay = Math.floor(Math.random() * 5) + 1;
      for (let j = 0; j < tweetsThisDay; j++) {
        const hourOffset = Math.floor(Math.random() * 16) + 7; // 7am-11pm
        tweets.push({
          timestamp: dayTs + hourOffset * 3600_000 + Math.random() * 3600_000,
          text: texts[Math.floor(Math.random() * texts.length)],
          url: `https://x.com/a1lon9/status/${Date.now() + tweets.length}`,
          likes: Math.floor(Math.random() * 500) + 10,
          reposts: Math.floor(Math.random() * 100) + 2,
          replies: Math.floor(Math.random() * 80) + 1,
        });
      }
    }

    return tweets.sort((a, b) => a.timestamp - b.timestamp);
  }

  function generateDemoPrices() {
    // Generate realistic OHLCV-style price data for $PUMP
    // Pattern: rise to peak in Sep, crash in Oct, recovery, then decline
    const prices = [];
    const start = new Date('2025-07-25').getTime();
    const end = new Date('2026-02-20').getTime();

    let price = 0.003; // start price
    const hour = 3600_000;

    for (let ts = start; ts <= end; ts += hour) {
      const day = (ts - start) / 86400_000;

      // Price trajectory
      let trend = 0;
      if (day < 15) trend = 0.002;       // gradual rise
      else if (day < 35) trend = 0.015;  // strong rise
      else if (day < 55) trend = 0.008;  // continued rise
      else if (day < 70) trend = -0.012; // correction
      else if (day < 85) trend = 0.005;  // bounce
      else if (day < 100) trend = -0.008; // decline
      else if (day < 130) trend = -0.003; // slow bleed
      else if (day < 160) trend = -0.006; // continued decline
      else if (day < 180) trend = -0.002; // bottoming
      else trend = 0.004;                // slight recovery

      price *= (1 + trend / 24 + (Math.random() - 0.5) * 0.03);
      price = Math.max(0.0005, price);

      prices.push({
        ts,
        price,
        open: price * (1 + (Math.random() - 0.5) * 0.01),
        high: price * (1 + Math.random() * 0.02),
        low: price * (1 - Math.random() * 0.02),
        close: price,
      });
    }

    return prices;
  }

  // ===== Render All =====
  function renderAll() {
    const { data } = state;
    if (!data) return;

    // Update header
    $('#tokenName').textContent = data.meta.tokenName || data.meta.token;
    $('#tokenNetwork').textContent = data.meta.tokenNetwork || '';
    $('#founderHandle').textContent = '@' + (data.meta.handle || '‚Äî');
    $('#tweetCountInfo').textContent = `${data.aligned.length} tweets ¬∑ ${data.meta.priceSource === 'coingecko' ? 'CoinGecko' : 'GeckoTerminal'}`;

    renderChart();
    if (state.view === 'data') renderTable();
    if (state.view === 'about') renderAbout();
  }

  // ===== CHART RENDERING =====
  function renderChart() {
    const { data } = state;
    if (!data) return;

    const chartEl = $('#chart');
    chartEl.innerHTML = '';
    $('#markersLayer').innerHTML = '';

    // Build daily OHLC from price data or aligned tweet prices
    const prices = data._prices || [];
    const dailyCandles = buildDailyCandles(prices);

    if (!dailyCandles.length) {
      chartEl.innerHTML = '<p style="text-align:center;padding:60px;color:var(--text-secondary)">No price data to display</p>';
      return;
    }

    // Create chart
    const chart = LightweightCharts.createChart(chartEl, {
      width: chartEl.clientWidth,
      height: chartEl.clientHeight,
      layout: {
        background: { type: 'solid', color: '#131722' },
        textColor: '#787b86',
        fontSize: 12,
      },
      grid: {
        vertLines: { color: '#1e222d' },
        horzLines: { color: '#1e222d' },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
        vertLine: { color: '#555', width: 1, style: LightweightCharts.LineStyle.Dashed },
        horzLine: { color: '#555', width: 1, style: LightweightCharts.LineStyle.Dashed },
      },
      rightPriceScale: {
        borderColor: '#2a2e39',
        scaleMargins: { top: 0.1, bottom: 0.1 },
      },
      timeScale: {
        borderColor: '#2a2e39',
        timeVisible: false,
        secondsVisible: false,
      },
      handleScroll: { vertTouchDrag: false },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a',
      downColor: '#ef5350',
      borderUpColor: '#26a69a',
      borderDownColor: '#ef5350',
      wickUpColor: '#26a69a',
      wickDownColor: '#ef5350',
    });

    candleSeries.setData(dailyCandles);

    // Add tweet markers on TradingView chart
    const tweetMarkers = buildTweetMarkers(data.aligned);
    if (tweetMarkers.length) {
      candleSeries.setMarkers(tweetMarkers);
    }

    state.chart = chart;
    state.candleSeries = candleSeries;

    // Resize handler
    const resizeObserver = new ResizeObserver(() => {
      chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
    });
    resizeObserver.observe(chartEl);

    // Price display on crosshair move
    chart.subscribeCrosshairMove(param => {
      if (param.time) {
        const data = param.seriesData.get(candleSeries);
        if (data) {
          const c = data.close;
          const o = data.open;
          const pct = ((c - o) / o * 100).toFixed(2);
          const color = c >= o ? 'var(--green-bright)' : 'var(--red)';
          $('#priceDisplay').innerHTML = `<span style="color:${color}">$${c.toFixed(6)} (${pct > 0 ? '+' : ''}${pct}%)</span>`;
        }
      }
    });

    fitChartRange();

    // Overlay HTML tweet markers (avatar bubbles)
    renderMarkerOverlays(data.aligned, chart, candleSeries);
  }

  function buildDailyCandles(prices) {
    if (!prices.length) return [];

    const dayMap = new Map();
    for (const p of prices) {
      const date = new Date(p.ts);
      const key = `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${String(date.getUTCDate()).padStart(2,'0')}`;
      if (!dayMap.has(key)) {
        dayMap.set(key, { time: key, open: p.price, high: p.price, low: p.price, close: p.price });
      } else {
        const c = dayMap.get(key);
        c.high = Math.max(c.high, p.price);
        c.low = Math.min(c.low, p.price);
        c.close = p.price;
      }
    }

    return [...dayMap.values()].sort((a, b) => a.time.localeCompare(b.time));
  }

  function buildTweetMarkers(aligned) {
    // Group tweets by day, add markers
    const dayMap = new Map();
    for (const t of aligned) {
      if (!t.priceAtTweet) continue;
      const d = new Date(t.timestamp);
      const key = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
      if (!dayMap.has(key)) dayMap.set(key, []);
      dayMap.get(key).push(t);
    }

    const markers = [];
    dayMap.forEach((tweets, day) => {
      const change24 = tweets[0]?.impact?.['24h']?.change;
      const color = change24 != null ? (change24 > 0 ? '#26a69a' : '#ef5350') : '#a855f7';
      markers.push({
        time: day,
        position: 'aboveBar',
        color,
        shape: 'circle',
        text: tweets.length > 1 ? String(tweets.length) : 'üê¶',
        size: tweets.length > 3 ? 2 : 1,
      });
    });

    return markers.sort((a, b) => a.time.localeCompare(b.time));
  }

  function renderMarkerOverlays(aligned, chart, series) {
    // This renders HTML avatar bubbles over the chart
    // We group tweets by day and position them on the chart
    const layer = $('#markersLayer');
    layer.innerHTML = '';

    const dayMap = new Map();
    for (const t of aligned) {
      if (!t.priceAtTweet) continue;
      const d = new Date(t.timestamp);
      const key = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
      if (!dayMap.has(key)) dayMap.set(key, []);
      dayMap.get(key).push(t);
    }

    const updatePositions = () => {
      layer.innerHTML = '';
      const timeScale = chart.timeScale();

      dayMap.forEach((tweets, day) => {
        const x = timeScale.timeToCoordinate(day);
        if (x === null || x < 0) return;

        const high = Math.max(...tweets.map(t => t.priceAtTweet));
        const y = series.priceToCoordinate(high);
        if (y === null) return;

        const count = tweets.length;
        const change24 = tweets[0]?.impact?.['24h']?.change;
        const borderColor = change24 != null ? (change24 > 0 ? 'var(--green)' : 'var(--red)') : 'var(--purple)';

        const marker = document.createElement('div');
        marker.className = 'tweet-marker';
        marker.style.left = (x - 16) + 'px';
        marker.style.top = (y - 44) + 'px';

        const avatarHTML = `<div class="marker-avatar" style="border-color:${borderColor}">üê¶</div>`;
        const countHTML = count > 1 ? `<div class="marker-count">${count}</div>` : '';

        // Tooltip
        const firstTweet = tweets[0];
        const dateStr = new Date(firstTweet.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const impactHTML = [];
        if (firstTweet.impact?.['1h']) {
          const c = firstTweet.impact['1h'].change;
          impactHTML.push(`<span class="${c >= 0 ? 'positive' : 'negative'}">1h: ${c > 0 ? '+' : ''}${c}%</span>`);
        }
        if (firstTweet.impact?.['24h']) {
          const c = firstTweet.impact['24h'].change;
          impactHTML.push(`<span class="${c >= 0 ? 'positive' : 'negative'}">24h: ${c > 0 ? '+' : ''}${c}%</span>`);
        }

        marker.innerHTML = `
          ${avatarHTML}${countHTML}
          <div class="tweet-tooltip">
            <div class="tt-date">${dateStr} ¬∑ ${count} tweet${count > 1 ? 's' : ''} ¬∑ $${firstTweet.priceAtTweet.toFixed(6)}</div>
            <div class="tt-text">${firstTweet.text.substring(0, 140)}${firstTweet.text.length > 140 ? '...' : ''}</div>
            <div class="tt-impact">${impactHTML.join(' ')}</div>
          </div>
        `;

        // Click to open tweet
        marker.addEventListener('click', () => {
          if (firstTweet.url) window.open(firstTweet.url, '_blank');
        });

        layer.appendChild(marker);
      });
    };

    updatePositions();
    chart.timeScale().subscribeVisibleLogicalRangeChange(updatePositions);
    chart.subscribeCrosshairMove(() => {}); // triggers re-render
    window.addEventListener('resize', updatePositions);
  }

  function fitChartRange() {
    if (!state.chart || !state.data) return;
    const ts = state.chart.timeScale();
    const aligned = state.data.aligned.filter(t => t.priceAtTweet);

    if (!aligned.length) { ts.fitContent(); return; }

    const toDay = (ms) => {
      const d = new Date(ms);
      return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
    };

    switch (state.chartRange) {
      case 'first': {
        const first = toDay(aligned[0].timestamp);
        ts.setVisibleRange({ from: first, to: toDay(aligned[0].timestamp + 7 * 86400_000) });
        break;
      }
      case 'last': {
        const last = aligned[aligned.length - 1].timestamp;
        ts.setVisibleRange({ from: toDay(last - 7 * 86400_000), to: toDay(last + 86400_000) });
        break;
      }
      case 'tweets': {
        const from = toDay(aligned[0].timestamp - 2 * 86400_000);
        const to = toDay(aligned[aligned.length - 1].timestamp + 2 * 86400_000);
        ts.setVisibleRange({ from, to });
        break;
      }
      default:
        ts.fitContent();
    }
  }

  // ===== DATA TABLE =====
  function renderTable() {
    const { data } = state;
    if (!data) return;

    let rows = data.aligned.map(t => ({
      datetime: t.timestamp,
      dateStr: new Date(t.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit', hour: '2-digit', minute: '2-digit' }),
      text: t.text || '',
      priceAtTweet: t.priceAtTweet,
      likes: t.likes || 0,
      reposts: t.reposts || 0,
      change1h: t.impact?.['1h']?.change ?? null,
      change24h: t.impact?.['24h']?.change ?? null,
      url: t.url,
    }));

    // Filter
    if (state.searchQuery) {
      const q = state.searchQuery.toLowerCase();
      rows = rows.filter(r => r.text.toLowerCase().includes(q) || r.dateStr.toLowerCase().includes(q));
    }

    // Sort
    rows.sort((a, b) => {
      let va = a[state.sortCol] ?? -Infinity;
      let vb = b[state.sortCol] ?? -Infinity;
      if (state.sortCol === 'change24h' || state.sortCol === 'change1h') {
        // Sort by absolute impact by default
        va = Math.abs(va); vb = Math.abs(vb);
      }
      return (va > vb ? 1 : va < vb ? -1 : 0) * state.sortDir;
    });

    const tbody = $('#tableBody');
    tbody.innerHTML = rows.map(r => `
      <tr onclick="window.open('${r.url}', '_blank')">
        <td>${r.dateStr}</td>
        <td class="tweet-text-cell">${escapeHtml(r.text.substring(0, 120))}${r.text.length > 120 ? '...' : ''}</td>
        <td>${r.priceAtTweet != null ? '$' + r.priceAtTweet.toFixed(6) : '‚Äî'}</td>
        <td>${fmtNum(r.likes)}</td>
        <td>${fmtNum(r.reposts)}</td>
        <td class="${r.change1h != null ? (r.change1h >= 0 ? 'change-positive' : 'change-negative') : 'change-neutral'}">${r.change1h != null ? (r.change1h > 0 ? '+' : '') + r.change1h + '%' : '‚Äî'}</td>
        <td class="${r.change24h != null ? (r.change24h >= 0 ? 'change-positive' : 'change-negative') : 'change-neutral'}">${r.change24h != null ? (r.change24h > 0 ? '+' : '') + r.change24h + '%' : '‚Äî'}</td>
      </tr>
    `).join('');

    // Update sort arrows
    $$('thead th').forEach(th => {
      th.classList.toggle('sorted', th.dataset.sort === state.sortCol);
    });
  }

  // Table sort
  $$('thead th').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (!col) return;
      if (state.sortCol === col) state.sortDir *= -1;
      else { state.sortCol = col; state.sortDir = -1; }
      renderTable();
    });
  });

  // Table search
  $('#tableSearch').addEventListener('input', (e) => {
    state.searchQuery = e.target.value;
    renderTable();
  });

  // CSV export
  $('#exportCSV').addEventListener('click', () => {
    if (!state.data) return;
    const rows = state.data.aligned.map(t => ({
      date: new Date(t.timestamp).toISOString(),
      text: (t.text || '').replace(/"/g, '""'),
      price: t.priceAtTweet,
      likes: t.likes || 0,
      reposts: t.reposts || 0,
      change_1h: t.impact?.['1h']?.change ?? '',
      change_24h: t.impact?.['24h']?.change ?? '',
      url: t.url || '',
    }));
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(','), ...rows.map(r => headers.map(h => {
      const v = r[h] ?? '';
      return typeof v === 'string' && (v.includes(',') || v.includes('"') || v.includes('\n')) ? `"${v}"` : v;
    }).join(','))].join('\n');
    downloadBlob(csv, `tweet-price-${state.data.meta.handle || 'export'}.csv`, 'text/csv');
  });

  // ===== ABOUT VIEW =====
  function renderAbout() {
    const { stats, meta, aligned } = state.data;
    if (!stats) {
      $('#statsGrid').innerHTML = '<p style="color:var(--text-secondary)">Not enough data for statistics</p>';
      return;
    }

    // Stats cards
    $('#statsGrid').innerHTML = [
      { value: stats.totalTweets, label: 'Total Tweets' },
      { value: stats.avgChange24h + '%', label: 'Avg 24h Change', color: stats.avgChange24h >= 0 ? 'var(--green-bright)' : 'var(--red)' },
      { value: stats.winRate + '%', label: 'Win Rate (24h)', color: stats.winRate >= 50 ? 'var(--green-bright)' : 'var(--red)' },
      { value: stats.bigMoves, label: 'Big Moves (¬±15%)' },
      { value: stats.medianChange24h + '%', label: 'Median 24h', color: stats.medianChange24h >= 0 ? 'var(--green-bright)' : 'var(--red)' },
      { value: stats.avgHoursBetweenTweets ? stats.avgHoursBetweenTweets + 'h' : '‚Äî', label: 'Avg Tweet Gap' },
    ].map(s => `
      <div class="stat-card">
        <div class="stat-value" ${s.color ? `style="color:${s.color}"` : ''}>${s.value}</div>
        <div class="stat-label">${s.label}</div>
      </div>
    `).join('');

    // Silences
    const silences = stats.silences || [];
    if (silences.length) {
      $('#silencesSection').style.display = '';
      $('#silencesList').innerHTML = silences.map(s => {
        const days = Math.round(s.gapHours / 24);
        const changeColor = s.priceChange != null ? (s.priceChange >= 0 ? 'var(--green-bright)' : 'var(--red)') : 'var(--text-secondary)';
        return `
          <div class="silence-card">
            <div>
              <div class="silence-dates">${new Date(s.startDate).toLocaleDateString()} ‚Üí ${new Date(s.endDate).toLocaleDateString()}</div>
              <div class="silence-gap">${days}d silence</div>
            </div>
            <div class="silence-change" style="color:${changeColor}">${s.priceChange != null ? (s.priceChange > 0 ? '+' : '') + s.priceChange + '%' : '‚Äî'}</div>
          </div>
        `;
      }).join('');
    } else {
      $('#silencesSection').style.display = 'none';
    }

    // Impact scatter plot
    renderImpactScatter(aligned);
  }

  function renderImpactScatter(aligned) {
    const canvas = $('#impactCanvas');
    const ctx = canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width - 40;
    canvas.height = 280;

    const w = canvas.width;
    const h = canvas.height;
    const pad = { top: 20, right: 20, bottom: 30, left: 50 };

    ctx.clearRect(0, 0, w, h);

    const withImpact = aligned.filter(t => t.impact?.['24h'] && t.priceAtTweet);
    if (!withImpact.length) return;

    const changes = withImpact.map(t => t.impact['24h'].change);
    const maxAbs = Math.max(Math.abs(Math.min(...changes)), Math.abs(Math.max(...changes)), 20);

    // Background
    ctx.fillStyle = '#1a1e2e';
    ctx.fillRect(0, 0, w, h);

    // Zero line
    const zeroY = pad.top + (h - pad.top - pad.bottom) / 2;
    ctx.strokeStyle = '#2a2e39';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad.left, zeroY);
    ctx.lineTo(w - pad.right, zeroY);
    ctx.stroke();

    // Axes labels
    ctx.fillStyle = '#787b86';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(`+${maxAbs.toFixed(0)}%`, pad.left - 6, pad.top + 4);
    ctx.fillText(`-${maxAbs.toFixed(0)}%`, pad.left - 6, h - pad.bottom + 4);
    ctx.fillText('0%', pad.left - 6, zeroY + 4);
    ctx.textAlign = 'center';
    ctx.fillText('Tweets over time ‚Üí', w / 2, h - 4);

    // Draw dots
    const plotW = w - pad.left - pad.right;
    const plotH = h - pad.top - pad.bottom;

    withImpact.forEach((t, i) => {
      const x = pad.left + (i / (withImpact.length - 1 || 1)) * plotW;
      const change = t.impact['24h'].change;
      const y = zeroY - (change / maxAbs) * (plotH / 2);
      const r = Math.min(6, Math.max(3, Math.abs(change) / 5));

      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fillStyle = change >= 0 ? 'rgba(38, 166, 154, 0.7)' : 'rgba(239, 83, 80, 0.7)';
      ctx.fill();
      ctx.strokeStyle = change >= 0 ? '#26a69a' : '#ef5350';
      ctx.lineWidth = 1;
      ctx.stroke();
    });
  }

  // ===== Utilities =====
  function showLoading(text) { $('#loadingOverlay').classList.add('active'); $('#loadingText').textContent = text; }
  function updateLoading(text) { $('#loadingText').textContent = text; }
  function hideLoading() { $('#loadingOverlay').classList.remove('active'); }

  function fmtNum(n) {
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
    return String(n);
  }

  function escapeHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function downloadBlob(content, filename, type) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type }));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ===== Init =====
  updateView();

})();
</script>
</body>
</html>
